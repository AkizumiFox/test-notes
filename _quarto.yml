project:
  type: book
  output-dir: _book

# Don't re-execute code in CI - use frozen results
execute:
  freeze: true

# Use pre-compiled mermaid SVGs in CI
filters:
  - mermaid-static

book:
  title: "Advanced Linear Algebra Notes"
  subtitle: "Spectral Theory & Optimization"
  author: "Tzu-You Lin"
  date: last-modified
  downloads: [pdf]
  # AUTO-GENERATED CHAPTERS - Do not edit manually
  # Run 'make update' to regenerate from src/ directory
  chapters:
    - index.qmd

    - part: src/ch01-foundations/index.qmd
      chapters:
        - src/ch01-foundations/01-vector-spaces.qmd
        - src/ch01-foundations/02-linear-maps.qmd

    - part: src/ch02-spectral-theory/index.qmd
      chapters:
        - src/ch02-spectral-theory/01-eigenvalues.qmd
        - src/ch02-spectral-theory/02-decompositions.qmd

    - part: src/ch03-optimization/index.qmd
      chapters:
        - src/ch03-optimization/01-convex-optimization.qmd

    - part: src/ch04-quarto-showcase/index.qmd
      chapters:
        - src/ch04-quarto-showcase/01-features.qmd
        - src/ch04-quarto-showcase/02-interactive.qmd

format:
  html:
    theme: cosmo
    toc: true
    number-sections: true
    code-tools: true
    html-math-method: mathjax
    css: config/html-styles.css
    include-after-body:
      text: |
        <script>
        document.addEventListener('DOMContentLoaded', function() {
          // ==========================================
          // 1. Add PDF download link to right TOC sidebar
          // ==========================================
          var path = window.location.pathname;
          
          if (!path.endsWith('/') && !path.endsWith('/index.html') && path !== '/index.html') {
            var pdfPath = path.replace(/\.html$/, '.pdf');
            var section = document.createElement('div');
            section.style.cssText = 'margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;';
            section.innerHTML = 
              '<h6 style="font-size:0.875rem;font-weight:600;margin-bottom:0.5rem;">Other Formats</h6>' +
              '<a href="' + pdfPath + '" style="display:flex;align-items:center;gap:0.5rem;color:inherit;text-decoration:none;font-size:0.875rem;">' +
              '<i class="bi bi-file-pdf" style="color:#dc3545;"></i> PDF</a>';
            
            var tocSidebar = document.querySelector('#quarto-margin-sidebar') ||
                             document.querySelector('.toc-active') ||
                             document.querySelector('#TOC');
            if (tocSidebar) {
              tocSidebar.appendChild(section);
            }
          }
          
          // ==========================================
          // 2. Shared theorem counter (Theorem, Lemma, Corollary, Proposition)
          // ==========================================
          var sharedCounter = 0;
          var definitionCounter = 0;
          var algorithmCounter = 0;
          var currentChapter = 0;
          
          // Types that share a counter
          var sharedTypes = ['theorem', 'lemma', 'corollary', 'proposition'];
          // Types with no counter (remove number)
          var noCounterTypes = ['conjecture', 'example', 'exercise', 'solution', 'remark'];
          
          // Process all theorem divs in document order
          document.querySelectorAll('div.theorem').forEach(function(div) {
            var titleSpan = div.querySelector('.theorem-title strong');
            if (!titleSpan) return;
            
            var text = titleSpan.textContent;
            var match = text.match(/^(\w+)\s+(\d+)\.(\d+)(.*)$/);
            if (!match) return;
            
            var typeName = match[1].toLowerCase();
            var chapterNum = parseInt(match[2]);
            var rest = match[4];
            
            // Reset counters on chapter change
            if (chapterNum !== currentChapter) {
              currentChapter = chapterNum;
              sharedCounter = 0;
              definitionCounter = 0;
              algorithmCounter = 0;
            }
            
            // Determine the specific type from classes
            var classes = Array.from(div.classList);
            var specificType = null;
            
            for (var i = 0; i < classes.length; i++) {
              var cls = classes[i];
              if (cls !== 'theorem' && (sharedTypes.indexOf(cls) >= 0 || cls === 'definition' || cls === 'algorithm' || noCounterTypes.indexOf(cls) >= 0)) {
                specificType = cls;
                break;
              }
            }
            
            // If no specific type found, it's a pure theorem
            if (!specificType && classes.indexOf('theorem') >= 0) {
              specificType = 'theorem';
            }
            
            var newNum = null;
            
            if (specificType === 'definition') {
              definitionCounter++;
              newNum = currentChapter + '.' + definitionCounter;
            } else if (specificType === 'algorithm') {
              algorithmCounter++;
              newNum = currentChapter + '.' + algorithmCounter;
            } else if (sharedTypes.indexOf(specificType) >= 0) {
              sharedCounter++;
              newNum = currentChapter + '.' + sharedCounter;
            } else if (noCounterTypes.indexOf(specificType) >= 0) {
              // Remove number
              var capitalType = specificType.charAt(0).toUpperCase() + specificType.slice(1);
              titleSpan.textContent = capitalType + rest;
              return;
            }
            
            if (newNum) {
              var capitalType = specificType.charAt(0).toUpperCase() + specificType.slice(1);
              titleSpan.textContent = capitalType + ' ' + newNum + rest;
            }
          });
        });
        </script>
    
  pdf:
    documentclass: extbook
    classoption: [13.5pt, a4paper, oneside, openany]
    number-sections: true
    colorlinks: true
    linkcolor: "blue"
    urlcolor: "blue"
    pdf-engine: lualatex
    linestretch: 1.1
    fig-width: 6
    fig-pos: "H"
    include-in-header:
      - text: |
          \usepackage[quartoenv]{./config/latex-template}
          % Strip numbers from unnumbered theorem environments
          \directlua{require("config/strip-numbers")}
          % Remove blank pages
          \usepackage{etoolbox}
          \makeatletter
          \patchcmd{\chapter}{\if@openright\cleardoublepage\else\clearpage\fi}{\clearpage}{}{}
          % Suppress title page
          \AtBeginDocument{\let\maketitle\relax}
          \makeatother
          % List spacing (1.3x)
          \usepackage{enumitem}
          \setlist{itemsep=1.2em, parsep=0pt}
          % Custom enumeration with prefix: \begin{customenum}{VS} gives VS1, VS2, ...
          \newlist{customenum}{enumerate}{1}
          \setlist[customenum,1]{label=\customenumprefix\arabic*, itemsep=1.2em}
          \newcommand{\customenumprefix}{}
          \input{config/chapter-style.tex}
    geometry:
      - margin=1.2in
